#!/bin/bash

# Ensure jq is installed
if ! command -v jq &> /dev/null
then
    echo "jq is not installed. Installing jq..."
    sudo apt-get update && sudo apt-get install -y jq
fi

# Define the search parameters
PRODUCT="o:microsoft:windows_10"
OUTPUT_FORMAT="json"
CVE_OUTPUT_DIR="/path/to/cve_output"

# Ensure the output directory exists
mkdir -p "$CVE_OUTPUT_DIR"

# Get the current date
DATE=$(date +%Y-%m-%d)

# Run the search and parse the JSON output with jq
/path/to/cve-search/bin/search.py -p $PRODUCT -o $OUTPUT_FORMAT | jq '.' > "$CVE_OUTPUT_DIR/cve_results_$DATE.json"

# Check if the search command was successful
if [ $? -ne 0 ]; then
    echo "CVE search failed. Please check the cve-search tool and parameters."
    exit 1
fi

# Optional: Clean up old files older than 30 days
find "$CVE_OUTPUT_DIR" -type f -name "*.json" -mtime +30 -exec rm {} \;

echo "CVE search completed and saved to $CVE_OUTPUT_DIR/cve_results_$DATE.json"
